<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Persistent Audio Host</title>
</head>
<body>

    <audio id="ambientAudio"
           src="/audio/sci-fi-moodtimeflow.mp3"
           loop></audio>

    <script>
        const audio = document.getElementById('ambientAudio');

        const MUSIC_ENABLED_KEY = 'ambientMusicEnabled';
        const MUSIC_TIME_KEY = 'ambientMusicTime';
        const MUSIC_VOLUME_KEY = 'ambientMusicVolume';
        const SESSION_START_KEY = 'sessionStartTime';

        const savedVolume = parseFloat(localStorage.getItem(MUSIC_VOLUME_KEY)) || 0.22;
        audio.volume = savedVolume;

        // Check if this is a new session (more than 30 minutes since last visit)
        const lastSession = localStorage.getItem(SESSION_START_KEY);
        const now = Date.now();
        const thirtyMinutes = 30 * 60 * 1000;
        const isNewSession = !lastSession || (now - parseInt(lastSession)) > thirtyMinutes;

        // Update session timestamp
        localStorage.setItem(SESSION_START_KEY, now.toString());

        // Default to enabled for new sessions
        let enabled = localStorage.getItem(MUSIC_ENABLED_KEY);
        if (enabled === null || isNewSession) {
            // First time or new session - default to ON
            enabled = 'true';
            localStorage.setItem(MUSIC_ENABLED_KEY, 'true');
        } else {
            enabled = enabled === 'true';
        }

        const savedTime = parseFloat(localStorage.getItem(MUSIC_TIME_KEY)) || 0;

        let hasTriedAutoplay = false;
        let audioUnlocked = false;

        audio.addEventListener('loadedmetadata', () => {
            // Restore playback position only if not a new session
            if (!isNewSession && savedTime > 0 && savedTime < audio.duration) {
                audio.currentTime = savedTime;
            }

            // Try to auto-resume if enabled
            if (enabled && !hasTriedAutoplay) {
                hasTriedAutoplay = true;
                audio.play().then(() => {
                    audioUnlocked = true;
                    console.log('ðŸŽµ Audio auto-started successfully');
                }).catch(err => {
                    console.log('â¸ï¸ Autoplay blocked - music will resume on interaction');
                    audioUnlocked = false;
                    // Set up one-time unlock listeners
                    setupAutoplayUnlock();
                });
            }
        });

        // Setup listeners to unlock audio on first interaction
        function setupAutoplayUnlock() {
            const unlockAudio = () => {
                if (!audioUnlocked && enabled) {
                    audio.play().then(() => {
                        audioUnlocked = true;
                        console.log('ðŸŽµ Audio unlocked via user interaction');
                        // Remove listeners after success
                        document.removeEventListener('click', unlockAudio);
                        document.removeEventListener('keydown', unlockAudio);
                        document.removeEventListener('touchstart', unlockAudio);
                    }).catch(() => {
                        // Keep trying on next interaction
                    });
                }
            };

            document.addEventListener('click', unlockAudio, { once: false });
            document.addEventListener('keydown', unlockAudio, { once: false });
            document.addEventListener('touchstart', unlockAudio, { once: false });
        }

        // Persist playback position
        audio.addEventListener('timeupdate', () => {
            localStorage.setItem(MUSIC_TIME_KEY, audio.currentTime);
        });

        // Listen for commands from parent pages
        window.addEventListener('message', (event) => {
            const { type, value } = event.data || {};

            switch (type) {
                case 'PLAY':
                    audio.play().then(() => {
                        audioUnlocked = true;
                    }).catch(() => { });
                    localStorage.setItem(MUSIC_ENABLED_KEY, 'true');
                    break;

                case 'PAUSE':
                    audio.pause();
                    localStorage.setItem(MUSIC_ENABLED_KEY, 'false');
                    break;

                case 'SET_VOLUME':
                    if (typeof value === 'number') {
                        audio.volume = Math.max(0, Math.min(1, value));
                        localStorage.setItem(MUSIC_VOLUME_KEY, audio.volume.toString());
                    }
                    break;

                case 'FADE_DOWN':
                    fadeTo(0.05, 400);
                    break;

                case 'FADE_UP':
                    const targetVolume = parseFloat(localStorage.getItem(MUSIC_VOLUME_KEY)) || 0.22;
                    fadeTo(targetVolume, 600);
                    break;
            }
        });

        let fadeInterval = null;

        function fadeTo(targetVolume, duration = 500) {
            clearInterval(fadeInterval);

            const startVolume = audio.volume;
            const steps = 20;
            const stepTime = duration / steps;
            let currentStep = 0;

            fadeInterval = setInterval(() => {
                currentStep++;
                audio.volume = startVolume + (targetVolume - startVolume) * (currentStep / steps);

                if (currentStep >= steps) {
                    audio.volume = targetVolume;
                    clearInterval(fadeInterval);
                }
            }, stepTime);
        }

        // Log status for debugging
        console.log('ðŸŽµ Audio Player Status:', {
            enabled: enabled,
            isNewSession: isNewSession,
            volume: audio.volume,
            savedTime: savedTime
        });
    </script>
</body>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile - The Measure of Souls</title>
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="navigation.css">
    <link rel="stylesheet" href="profile.css">
    <link rel="stylesheet" href="animations.css">
    <link rel="stylesheet" href="mobile-fixes.css">
</head>
<body>
    <!-- Page Transition Overlay -->
    <div class="page-transition"></div>

    <!-- Animated Background -->
    <div class="matrix-style-bg"></div>

    <!-- Profile Container -->
    <div class="profile-container">
        <div class="profile-card">
            <!-- Header -->
            <div class="profile-header">
                <div class="profile-icon">üë§</div>
                <h1>USER PROFILE</h1>
                <button class="logout-btn" id="logoutBtn">LOGOUT</button>
            </div>

            <!-- Loading State -->
            <div class="loading-state" id="loadingState">
                <div class="loading-spinner"></div>
                <p>Loading profile data...</p>
            </div>

            <!-- Profile Content -->
            <div class="profile-content" id="profileContent" style="display: none;">

                <!-- Account Info -->
                <div class="profile-section">
                    <h2 class="section-title">ACCOUNT INFORMATION</h2>

                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">USERNAME</div>
                            <div class="info-value" id="profileUsername">-</div>
                        </div>

                        <div class="info-item">
                            <div class="info-label">EMAIL</div>
                            <div class="info-value" id="profileEmail">-</div>
                        </div>

                        <div class="info-item">
                            <div class="info-label">ACCOUNT TYPE</div>
                            <div class="info-value" id="profileAccountType">-</div>
                        </div>

                        <div class="info-item">
                            <div class="info-label">MEMBER SINCE</div>
                            <div class="info-value" id="profileCreatedAt">-</div>
                        </div>

                        <div class="info-item">
                            <div class="info-label">ADMIN STATUS</div>
                            <div class="info-value" id="profileAdminStatus">-</div>
                        </div>
                    </div>
                </div>

                <!-- Progress Stats -->
                <div class="profile-section">
                    <h2 class="section-title">PROGRESS STATISTICS</h2>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon">üì¶</div>
                            <div class="stat-value" id="statFragments">0 / 10</div>
                            <div class="stat-label">Memory Fragments</div>
                            <div class="stat-progress">
                                <div class="progress-bar" id="fragmentsProgress"></div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">üîì</div>
                            <div class="stat-value" id="statRiddles">0 / 10</div>
                            <div class="stat-label">Riddles Solved</div>
                            <div class="stat-progress">
                                <div class="progress-bar" id="riddlesProgress"></div>
                            </div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-icon">üì°</div>
                            <div class="stat-value" id="statSignal">0%</div>
                            <div class="stat-label">Signal Decoded</div>
                            <div class="stat-progress">
                                <div class="progress-bar" id="signalProgress"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="profile-section">
                    <h2 class="section-title">QUICK ACTIONS</h2>

                    <div class="actions-grid">
                        <a href="signal.html" class="action-btn">
                            <span class="action-icon">üì°</span>
                            <span>Continue Decoder</span>
                        </a>

                        <a href="index.html" class="action-btn">
                            <span class="action-icon">üì¶</span>
                            <span>Collect Fragments</span>
                        </a>

                        <a href="quantum-entanglement.html" class="action-btn">
                            <span class="action-icon">‚öõÔ∏è</span>
                            <span>Quantum Entangle</span>
                        </a>

                        <a href="fragments-complete.html" class="action-btn">
                            <span class="action-icon">üîí</span>
                            <span>Secret Page</span>
                        </a>
                    </div>
                </div>

                <!-- Settings -->
                <div class="profile-section">
                    <h2 class="section-title">SETTINGS</h2>

                    <div class="settings-list">
                        <div class="setting-item">
                            <div class="setting-info">
                                <div class="setting-name">Clear Local Progress</div>
                                <div class="setting-description">Reset all memory fragments and decoder progress</div>
                            </div>
                            <button class="danger-btn" id="clearProgressBtn">CLEAR</button>
                        </div>

                        <div class="setting-item" id="deleteAccountSetting">
                            <div class="setting-info">
                                <div class="setting-name">Delete Account</div>
                                <div class="setting-description">Permanently delete your account and all data</div>
                            </div>
                            <button class="danger-btn" id="deleteAccountBtn">DELETE</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>

        <!-- Back to Home -->
        <div class="back-link">
            <a href="index.html">‚Üê Back to Home</a>
        </div>
    </div>

    <!-- Confirmation Modal -->
    <div class="modal-overlay" id="confirmModal" style="display: none;">
        <div class="modal-content">
            <h2 id="confirmTitle">Confirm Action</h2>
            <p id="confirmMessage">Are you sure?</p>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="confirmCancelBtn">Cancel</button>
                <button class="modal-btn danger" id="confirmActionBtn">Confirm</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>&copy; 2026 THE MEASURE OF SOULS TRILOGY. ALL RIGHTS RESERVED.</p>
            <p class="footer-tagline">Stories That Transcend Reality</p>
        </div>
        <div class="footer-links">
            <a href="privacy-policy.html">Privacy Policy</a>
            <span>|</span>
            <a href="#">Terms of Service</a>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <!-- Initialize Firebase ONCE -->
    <script src="firebase-config.js"></script>

    <!-- Le scripts -->
    <script src="storage-wrapper.js"></script>
    <script src="cookie-consent.js"></script>
    <script src="audio-player.js"></script>
    <script src="quantum-entanglement.js"></script>
    <script src="auth.js"></script>
    <script src="script.js"></script>
    <script src="load-navigation.js"></script>
    <script src="memory-fragments.js"></script>
    <script src="breadcrumbs.js"></script>

    <script>
        // ============================================
        // PROFILE PAGE LOGIC - WRAPPED IN WAIT CHECK
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            const loadingState = document.getElementById('loadingState');
            const profileContent = document.getElementById('profileContent');

            // WAIT FOR AUTHSYSTEM TO BE READY
            const waitForAuthSystem = (cb, interval = 40, timeout = 5000) => {
                const start = Date.now();
                (function poll() {
                    if (window.authSystem) return cb();
                    if (Date.now() - start > timeout) {
                        console.error('authSystem not available after timeout');
                        loadingState.innerHTML = '<p style="color: var(--accent-red);">Error loading authentication system. Please refresh.</p>';
                        return;
                    }
                    setTimeout(poll, interval);
                })();
            };

            waitForAuthSystem(() => {
                console.log('‚úÖ authSystem ready on profile page');

                // Redirect if not logged in
                authSystem.onAuthStateChange(async (user) => {
                    if (!user) {
                        window.location.href = 'login.html';
                        return;
                    }

                    // Load profile data
                    await loadProfileData(user);
                });

                // Check if already logged in
                if (firebase.auth().currentUser) {
                    loadProfileData(firebase.auth().currentUser);
                }
            });

            async function loadProfileData(user) {
                try {
                    console.log('Loading profile for user:', user.uid);

                    // Get user profile from database
                    const snapshot = await firebase.database().ref('users/' + user.uid).once('value');
                    const profile = snapshot.val();

                    if (!profile) {
                        console.error('Profile not found');
                        loadingState.innerHTML = '<p style="color: var(--accent-red);">Profile not found. Please contact support.</p>';
                        return;
                    }

                    console.log('Profile loaded:', profile);

                    // Update basic info
                    document.getElementById('profileUsername').textContent = profile.username;
                    document.getElementById('profileEmail').textContent = profile.email || 'Anonymous Account';
                    document.getElementById('profileAccountType').textContent =
                        profile.accountType === 'email' ? 'Email Account' : 'Anonymous Account';

                    if (profile.createdAt) {
                        const date = new Date(profile.createdAt);
                        document.getElementById('profileCreatedAt').textContent = date.toLocaleDateString();
                    }

                    // Display admin status
                    const isAdmin = profile.isAdmin === true;
                    const adminStatusElement = document.getElementById('profileAdminStatus');
                    adminStatusElement.textContent = isAdmin ? 'YES' : 'NO';
                    adminStatusElement.style.color = isAdmin ? 'var(--accent-cyan)' : 'var(--primary-white)';
                    if (isAdmin) {
                        adminStatusElement.style.textShadow = '0 0 10px var(--accent-cyan)';
                    }

                    // Load progress stats
                    loadProgressStats(profile);

                    // Show content
                    loadingState.style.display = 'none';
                    profileContent.style.display = 'block';

                    // Hide delete account button for anonymous users (can't recover)
                    if (profile.accountType === 'anonymous') {
                        document.getElementById('deleteAccountSetting').style.display = 'none';
                    }

                } catch (error) {
                    console.error('Error loading profile:', error);
                    loadingState.innerHTML = '<p style="color: var(--accent-red);">Error loading profile. Please try again.</p>';
                }
            }

            function loadProgressStats(profile) {
                // Memory Fragments
                const fragments = profile.memoryFragments || [];
                const fragmentsCount = fragments.length;
                const fragmentsPercent = (fragmentsCount / 10) * 100;
                document.getElementById('statFragments').textContent = `${fragmentsCount} / 10`;
                document.getElementById('fragmentsProgress').style.width = fragmentsPercent + '%';

                // Riddles Solved
                const riddles = profile.riddlesSolved || [];
                const riddlesCount = riddles.length;
                const riddlesPercent = (riddlesCount / 10) * 100;
                document.getElementById('statRiddles').textContent = `${riddlesCount} / 10`;
                document.getElementById('riddlesProgress').style.width = riddlesPercent + '%';

                // Signal Progress
                const signalProgress = profile.signalProgress || 0;
                document.getElementById('statSignal').textContent = Math.round(signalProgress) + '%';
                document.getElementById('signalProgress').style.width = signalProgress + '%';
            }

            // ============================================
            // LOGOUT
            // ============================================

            document.getElementById('logoutBtn').addEventListener('click', async () => {
                if (!window.authSystem) {
                    console.error('authSystem not available');
                    return;
                }
                const result = await authSystem.signOut();
                if (result.success) {
                    window.location.href = 'login.html';
                }
            });

            // ============================================
            // CLEAR PROGRESS
            // ============================================

            document.getElementById('clearProgressBtn').addEventListener('click', () => {
                showConfirmModal(
                    'Clear Progress',
                    'This will reset all memory fragments and decoder progress. This cannot be undone. Continue?',
                    clearProgress
                );
            });

            async function clearProgress() {
                try {
                    const user = firebase.auth().currentUser;
                    if (!user) return;

                    // Clear in database
                    await firebase.database().ref('users/' + user.uid).update({
                        memoryFragments: [],
                        riddlesSolved: [],
                        signalProgress: 0
                    });

                    // Clear localStorage
                    localStorage.removeItem('collectedMemoryFragments');
                    localStorage.removeItem('solvedRiddles');

                    // Reload page
                    location.reload();
                } catch (error) {
                    console.error('Error clearing progress:', error);
                    alert('Failed to clear progress. Please try again.');
                }
            }

            // ============================================
            // DELETE ACCOUNT
            // ============================================

            document.getElementById('deleteAccountBtn').addEventListener('click', () => {
                showConfirmModal(
                    'Delete Account',
                    '‚ö†Ô∏è WARNING: This will permanently delete your account and ALL data. This CANNOT be undone. Type your username to confirm.',
                    deleteAccount,
                    true
                );
            });

            async function deleteAccount() {
                try {
                    const user = firebase.auth().currentUser;
                    if (!user) return;

                    // Delete user data from database
                    await firebase.database().ref('users/' + user.uid).remove();

                    // Remove username from taken list
                    const username = await authSystem.getUsername();
                    if (username) {
                        await firebase.database().ref('usernames/' + username.toLowerCase()).remove();
                    }

                    // Delete user account
                    await user.delete();

                    alert('Account deleted successfully');
                    window.location.href = 'index.html';

                } catch (error) {
                    console.error('Error deleting account:', error);
                    alert('Failed to delete account. You may need to log in again first.');
                }
            }

            // ============================================
            // CONFIRMATION MODAL
            // ============================================

            const confirmModal = document.getElementById('confirmModal');
            const confirmTitle = document.getElementById('confirmTitle');
            const confirmMessage = document.getElementById('confirmMessage');
            const confirmCancelBtn = document.getElementById('confirmCancelBtn');
            const confirmActionBtn = document.getElementById('confirmActionBtn');

            let confirmCallback = null;

            function showConfirmModal(title, message, callback, requireUsername = false) {
                confirmTitle.textContent = title;

                if (requireUsername) {
                    confirmMessage.innerHTML = `
                                ${message}
                                <input type="text" id="confirmUsernameInput" placeholder="Enter username"
                                    style="width: 100%; margin-top: 1rem; padding: 0.8rem; background: rgba(0,0,0,0.5);
                                    border: 1px solid rgba(255,255,255,0.3); color: white; font-family: 'Courier New', monospace;">
                            `;
                } else {
                    confirmMessage.textContent = message;
                }

                confirmCallback = callback;
                confirmModal.style.display = 'flex';
            }

            confirmCancelBtn.addEventListener('click', () => {
                confirmModal.style.display = 'none';
                confirmCallback = null;
            });

            confirmActionBtn.addEventListener('click', async () => {
                // Check username confirmation if required
                const usernameInput = document.getElementById('confirmUsernameInput');
                if (usernameInput) {
                    const enteredUsername = usernameInput.value.trim();
                    const actualUsername = document.getElementById('profileUsername').textContent;

                    if (enteredUsername !== actualUsername) {
                        alert('Username does not match. Action cancelled.');
                        return;
                    }
                }

                confirmModal.style.display = 'none';

                if (confirmCallback) {
                    await confirmCallback();
                    confirmCallback = null;
                }
            });
        });
    </script>

</body>
</html>
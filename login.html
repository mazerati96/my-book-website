<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Login - The Measure of Souls</title>
    <link rel="stylesheet" href="base.css">
    <link rel="stylesheet" href="navigation.css">
    <link rel="stylesheet" href="login.css">
    <link rel="stylesheet" href="animations.css">

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <!-- Page Transition Overlay -->
    <div class="page-transition"></div>

    <!-- Animated Background -->
    <div class="matrix-style-bg"></div>

    <!-- Login Container -->
    <div class="login-container">
        <div class="login-card">
            <!-- Header -->
            <div class="login-header">
                <div class="login-brackets">[</div>
                <h1>AUTHENTICATION</h1>
                <div class="login-brackets">]</div>
            </div>

            <div class="login-subtitle">THE MEASURE OF SOULS</div>

            <!-- Tab Switcher -->
            <div class="auth-tabs">
                <button class="auth-tab active" data-tab="email">Email Account</button>
                <button class="auth-tab" data-tab="anonymous">Anonymous</button>
                <button class="auth-tab" data-tab="guest">Guest Mode</button>
            </div>

            <!-- Email/Password Form -->
            <div class="auth-form active" id="emailForm">
                <div class="form-mode-toggle">
                    <button class="mode-btn active" data-mode="login">Login</button>
                    <button class="mode-btn" data-mode="signup">Sign Up</button>
                </div>

                <form id="emailAuthForm">
                    <!-- Username (signup only) -->
                    <div class="form-group" id="usernameGroup" style="display: none;">
                        <label for="username">Username</label>
                        <input type="text" id="username" placeholder="3-15 characters, no spaces" maxlength="15" required>
                        <div class="form-hint">Case-sensitive. Can use letters, numbers, _ and -</div>
                    </div>

                    <!-- Email -->
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" placeholder="your@email.com" required>
                    </div>

                    <!-- Password -->
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" placeholder="Minimum 6 characters" required>
                    </div>

                    <!-- Error Message -->
                    <div class="error-message" id="emailError" style="display: none;"></div>

                    <!-- Submit Button -->
                    <button type="submit" class="submit-btn" id="emailSubmitBtn">
                        <span>LOGIN</span>
                        <div class="btn-glow"></div>
                    </button>

                    <!-- Forgot Password -->
                    <div class="forgot-password">
                        <button type="button" id="forgotPasswordBtn">Forgot password?</button>
                    </div>
                </form>
            </div>

            <!-- Anonymous Form -->
            <div class="auth-form" id="anonymousForm">
                <div class="anonymous-info">
                    ⚠️ Anonymous accounts have no email. If you clear browser data, you'll lose access permanently.
                </div>

                <form id="anonymousAuthForm">
                    <div class="form-group">
                        <label for="anonUsername">Choose Username</label>
                        <input type="text" id="anonUsername" placeholder="Your unique identifier" maxlength="15" required>
                        <div class="form-hint">Case-sensitive. Can use letters, numbers, _ and -</div>
                    </div>

                    <div class="form-group">
                        <label for="anonPassword">Create Password</label>
                        <input type="password" id="anonPassword" placeholder="Minimum 6 characters" required>
                        <div class="form-hint">You'll need this to login, but cannot reset it</div>
                    </div>

                    <div class="error-message" id="anonError" style="display: none;"></div>

                    <button type="submit" class="submit-btn">
                        <span>CREATE ANONYMOUS ACCOUNT</span>
                        <div class="btn-glow"></div>
                    </button>
                </form>
            </div>

            <!-- Guest Mode -->
            <div class="auth-form" id="guestForm">
                <div class="guest-info">
                    <h3>Continue as Guest</h3>
                    <p>Browse the site without an account. Your progress won't be saved.</p>
                    <ul class="guest-limitations">
                        <li>✗ Memory fragments progress not saved</li>
                        <li>✗ Signal decoder progress not saved</li>
                        <li>✗ Random Quantum Entanglement ID</li>
                        <li>✓ Full site access</li>
                    </ul>
                    <button class="submit-btn" id="guestContinueBtn">
                        <span>CONTINUE AS GUEST</span>
                        <div class="btn-glow"></div>
                    </button>
                </div>
            </div>
        </div>

        <!-- Back to Home -->
        <div class="back-link">
            <a href="index.html">← Back to Home</a>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div class="modal-overlay" id="resetModal" style="display: none;">
        <div class="modal-content">
            <h2>Reset Password</h2>
            <p>Enter your email address to receive a password reset link.</p>
            <input type="email" id="resetEmail" placeholder="your@email.com" class="form-input">
            <div class="error-message" id="resetError" style="display: none;"></div>
            <div class="success-message" id="resetSuccess" style="display: none;">✓ Reset email sent! Check your inbox.</div>
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="resetCancelBtn">Cancel</button>
                <button class="modal-btn primary" id="resetSendBtn">Send Reset Link</button>
            </div>
        </div>
    </div>

    <script src="auth.js"></script>
    <script src="script.js"></script>
    <script src="load-navigation.js"></script>

    <script>
        // ============================================
        // LOGIN PAGE LOGIC
        // ============================================

        // Redirect if already logged in
        authSystem.onAuthStateChange((user) => {
            if (user) {
                window.location.href = 'profile.html';
            }
        });

        // Tab switching
        const authTabs = document.querySelectorAll('.auth-tab');
        const authForms = document.querySelectorAll('.auth-form');

        authTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetTab = tab.dataset.tab;

                authTabs.forEach(t => t.classList.remove('active'));
                authForms.forEach(f => f.classList.remove('active'));

                tab.classList.add('active');
                document.getElementById(targetTab + 'Form').classList.add('active');
            });
        });

        // Email form mode toggle (login/signup)
        const modeBtns = document.querySelectorAll('.mode-btn');
        const usernameGroup = document.getElementById('usernameGroup');
        const emailSubmitBtn = document.getElementById('emailSubmitBtn');

        modeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const mode = btn.dataset.mode;

                modeBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');

                if (mode === 'signup') {
                    usernameGroup.style.display = 'block';
                    emailSubmitBtn.querySelector('span').textContent = 'SIGN UP';
                } else {
                    usernameGroup.style.display = 'none';
                    emailSubmitBtn.querySelector('span').textContent = 'LOGIN';
                }
            });
        });

        // Email form submission
        document.getElementById('emailAuthForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const mode = document.querySelector('.mode-btn.active').dataset.mode;
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const username = document.getElementById('username').value.trim();
            const errorEl = document.getElementById('emailError');
            const submitBtn = document.getElementById('emailSubmitBtn');

            errorEl.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.querySelector('span').textContent = 'PROCESSING...';

            let result;
            if (mode === 'signup') {
                result = await authSystem.signUpWithEmail(email, password, username);
            } else {
                result = await authSystem.signInWithEmail(email, password);
            }

            if (result.success) {
                window.location.href = 'profile.html';
            } else {
                errorEl.textContent = result.error;
                errorEl.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.querySelector('span').textContent = mode === 'signup' ? 'SIGN UP' : 'LOGIN';
            }
        });

        // Anonymous form submission
        document.getElementById('anonymousAuthForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const username = document.getElementById('anonUsername').value.trim();
            const errorEl = document.getElementById('anonError');
            const submitBtn = e.target.querySelector('.submit-btn');

            errorEl.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.querySelector('span').textContent = 'CREATING...';

            const result = await authSystem.signInAnonymously(username);

            if (result.success) {
                window.location.href = 'profile.html';
            } else {
                errorEl.textContent = result.error;
                errorEl.style.display = 'block';
                submitBtn.disabled = false;
                submitBtn.querySelector('span').textContent = 'CREATE ANONYMOUS ACCOUNT';
            }
        });

        // Guest mode
        document.getElementById('guestContinueBtn').addEventListener('click', () => {
            // Set guest mode flag
            localStorage.setItem('guestMode', 'true');
            window.location.href = 'index.html';
        });

        // Forgot password modal
        const resetModal = document.getElementById('resetModal');
        const forgotBtn = document.getElementById('forgotPasswordBtn');
        const resetCancelBtn = document.getElementById('resetCancelBtn');
        const resetSendBtn = document.getElementById('resetSendBtn');

        forgotBtn.addEventListener('click', () => {
            resetModal.style.display = 'flex';
        });

        resetCancelBtn.addEventListener('click', () => {
            resetModal.style.display = 'none';
        });

        resetSendBtn.addEventListener('click', async () => {
            const email = document.getElementById('resetEmail').value.trim();
            const errorEl = document.getElementById('resetError');
            const successEl = document.getElementById('resetSuccess');

            errorEl.style.display = 'none';
            successEl.style.display = 'none';

            if (!email) {
                errorEl.textContent = 'Please enter your email';
                errorEl.style.display = 'block';
                return;
            }

            resetSendBtn.disabled = true;
            resetSendBtn.textContent = 'Sending...';

            const result = await authSystem.sendPasswordReset(email);

            if (result.success) {
                successEl.style.display = 'block';
                setTimeout(() => {
                    resetModal.style.display = 'none';
                }, 3000);
            } else {
                errorEl.textContent = result.error;
                errorEl.style.display = 'block';
            }

            resetSendBtn.disabled = false;
            resetSendBtn.textContent = 'Send Reset Link';
        });
    </script>
</body>
</html>